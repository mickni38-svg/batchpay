<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BatchPay – Ordrer (kompakt)</title>
  <style>
    /* ========= Tema-variabler ========= */
    :root{--bg:#07111a;--panel:#0b1720;--panel2:#0a141b;--muted:#93a4b8;--text:#e6f1f5;--line:#113040;--admin:#10b981;--accent:#34d399;--accent-strong:#059669;--chip:#0d2430;}
    body.theme-emerald{--bg:#07111a;--panel:#0b1720;--panel2:#0a141b;--muted:#93a4b8;--text:#e6f1f5;--line:#113040;--admin:#10b981;--accent:#34d399;--accent-strong:#059669;--chip:#0d2430;}
    body.theme-sapphire{--bg:#070c19;--panel:#0b1026;--panel2:#0a0f1f;--muted:#9aa7d1;--text:#e7ecff;--line:#1a2759;--admin:#3b82f6;--accent:#60a5fa;--accent-strong:#1d4ed8;--chip:#0b1337;}
    body.theme-violet{--bg:#0d0816;--panel:#160d2a;--panel2:#120a22;--muted:#b7a8d9;--text:#f0eaff;--line:#2c1c58;--admin:#a78bfa;--accent:#c4b5fd;--accent-strong:#7c3aed;--chip:#1a0f3b;}
    body.theme-sunset{--bg:#100b06;--panel:#1a1209;--panel2:#150f0b;--muted:#d2b9a7;--text:#fff4ec;--line:#3a2514;--admin:#f59e0b;--accent:#fbbf24;--accent-strong:#d97706;--chip:#24150a;}

    /* ========= Basestyles ========= */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);font-size:15px}
    .page{max-width:980px;margin:18px auto;padding:0 12px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.3);overflow:hidden}
    .header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #0f2a37}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:8px;background:radial-gradient(120px 60px at -20% -20%, color-mix(in oklab, var(--admin), transparent 40%), transparent 60%), #06131a;border:1px solid #0f2a37}
    .logo svg{width:18px;height:18px}
    .title{font-size:16px;font-weight:800}
    .merchant{font-size:11px;color:var(--muted);line-height:1.2}
    .rightHead{display:flex;align-items:center;gap:10px}
    .user{font-size:11px;color:var(--muted)}
    .swatches{display:flex;gap:6px;align-items:center}
    .swLabel{font-size:11px;color:var(--muted)}
    .sw{width:12px;height:12px;border-radius:50%;border:2px solid color-mix(in oklab, var(--text), transparent 70%);cursor:pointer;display:inline-block;box-shadow:0 0 0 2px color-mix(in oklab, #000, transparent 70%) inset}
    .sw.emerald{background:linear-gradient(180deg,#34d399,#059669)}
    .sw.sapphire{background:linear-gradient(180deg,#60a5fa,#1d4ed8)}
    .sw.violet{background:linear-gradient(180deg,#c4b5fd,#7c3aed)}
    .sw.sunset{background:linear-gradient(180deg,#fbbf24,#d97706)}

    .topctl{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid #0f2a37;background:var(--panel2)}
    .toggle{position:relative;width:40px;height:22px;border-radius:999px;background:#0d2833;border:1px solid #13465a;cursor:pointer;flex-shrink:0}
    .toggle::after{content:"";position:absolute;top:2px;left:2px;width:15px;height:15px;border-radius:50%;background:#67e8f9;transition:all .2s ease}
    .toggle.on{background:#064e3b;border-color:#065f46}
    .toggle.on::after{left:22px;background:#a7f3d0}
    .toggleLabel{font-size:13px}

    /* Tabs (underline style) */
    .tabs{display:flex;gap:16px;background:var(--panel2);border-bottom:1px solid #0f2a37;padding:8px 10px;overflow-x:auto}
    .tab{appearance:none;background:transparent;border:none;color:#cbe3ea;padding:8px 0;font-weight:800;cursor:pointer;border-bottom:2px solid transparent;font-size:14px}
    .tab.active{color:#fff;border-bottom-color:var(--accent)}

    .content{padding:10px;display:grid;gap:10px}
    .muted{color:var(--muted);font-size:11px}
    .pill{font-size:10.5px;padding:2px 6px;border-radius:999px;border:1px solid #124b3b;color:#bfffe5;background:#06211a}
    .pill.ok{border-color:#0e5135;color:#baf7d3;background:#082316}
    .pill.warn{border-color:#5e4a0f;color:#fde68a;background:#2a2308}
    .pill.bad{border-color:#6b1111;color:#fecaca;background:#2a0b0b}

    .btn{padding:7px 10px;border-radius:10px;border:1px solid #174b57;background:#0a1f28;color:#e2f7f4;cursor:pointer;font-size:13px}
    .btn.primary{border-color:var(--accent-strong);background:linear-gradient(180deg,var(--admin),var(--accent-strong));color:#06211a;font-weight:800}
    .btn.ghost{background:transparent;border-color:#0f2a37}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}

    /* Toolbar kompakt */
    .toolbar{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:6px;padding:8px;border:1px solid var(--line);border-radius:12px;background:#081b23;margin-bottom:8px}
    .toolbar.admin{background:#092526;border-color:#0d4c40;box-shadow:0 0 0 1px rgba(16,185,129,.25) inset}
    .toolbar .btn.primary{grid-column:1/-1}

    /* Ordrekort + header */
    .orderCard{position:relative;border:1px solid var(--line);background:#0b1920;border-radius:14px;overflow:hidden;margin:6px 0;}
    .orderHead{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;cursor:pointer;background:#0c2028}
    .orderTitle{display:flex;align-items:center;gap:8px;min-width:0}
    .orderTitle strong{font-size:14px}
    .chev{transition:transform .2s ease;flex:0 0 auto}
    .orderCard.open .chev{transform:rotate(90deg)}
    .orderMeta{display:flex;gap:6px;align-items:center}
    .orderBody{display:none;padding:8px 10px;border-top:1px dashed var(--line)}
    .orderCard.open .orderBody{display:block}

    .adminBadge{font-size:9.5px;text-transform:uppercase;letter-spacing:.05em;font-weight:900;padding:3px 6px;border-radius:999px;display:inline-flex;align-items:center;gap:4px;color:#05251b;background:linear-gradient(180deg,#34d399,#10b981);border:1px solid #0b6d56}

    /* Accordion person */
    .acc{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .acc-item{border:1px solid var(--line);background:#0e222b;border-radius:12px;overflow:hidden}
    .acc-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;cursor:pointer}
    .acc-left{display:flex;align-items:center;gap:10px;min-width:0}
    .avatar{width:22px;height:22px;border-radius:999px;background:#0b2a22;border:1px solid #0a6f5b;display:flex;align-items:center;justify-content:center;font-size:10px;color:#b7fff0}
    .name{font-weight:700;font-size:13px}
    .status{font-size:10.5px}
    .sum{font-variant-numeric:tabular-nums;white-space:nowrap;font-size:13px}
    .acc-body{padding:0 10px 8px 42px;background:#0b1f26;border-top:1px dashed var(--line);display:none}
    .acc-item.open .acc-body{display:block}

    /* Linjer inside person */
    .line-row{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);background:#0c2330;padding:6px 8px;border-radius:10px;margin-top:6px;gap:10px}
    .line-name{display:flex;flex-direction:column;min-width:0}
    .line-name strong{font-size:13px}
    .line-amount{font-variant-numeric:tabular-nums;white-space:nowrap;font-size:13px}
    .switch{position:relative;width:34px;height:18px;background:#0f2430;border:1px solid #1a4455;border-radius:999px;cursor:pointer;flex-shrink:0}
    .switch[aria-disabled="true"]{opacity:.5;cursor:not-allowed}
    .switch::after{content:"";position:absolute;top:2px;left:2px;width:12px;height:12px;background:#67e8f9;border-radius:50%;transition:all .2s ease}
    .switch.on{background:#064e3b;border-color:#0d6d57}
    .switch.on::after{left:18px;background:#a7f3d0}

    /* Items view */
    .itemList{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .itemCard{border:1px solid var(--line);background:#0e222b;border-radius:12px;padding:8px 10px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 7px;border-radius:999px;background:var(--chip);border:1px solid #155e75;color:#c3efff;font-size:11px}

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .overlay.open{display:flex}
    .modal{width:100%;max-width:520px;background:linear-gradient(180deg,var(--panel2),var(--panel));border:1px solid var(--line);border-radius:14px;box-shadow:0 30px 100px rgba(0,0,0,.6);overflow:hidden}
    .m-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
    .m-title{font-weight:800}
    .m-body{padding:12px;line-height:1.55;color:color-mix(in oklab, var(--text), white 8%)}
    .m-foot{padding:10px 12px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:8px}
    .x{all:unset;cursor:pointer;color:var(--muted);padding:8px;border-radius:10px}
    .x:hover{background:color-mix(in oklab, var(--panel), #000 10%)}

    /* Ekstra kompakt for meget små skærme */
    @media (max-width: 420px){
      body{font-size:13px}
      .title{font-size:14px}
      .tab{font-size:12.5px}
      .toolbar .btn{font-size:12px;padding:7px 8px}
      .btn.primary{font-size:12.5px}
      .adminBadge{font-size:9px}
      .acc-body{padding-left:38px}
      .line-name strong{font-size:12.5px}
      .sum,.line-amount{font-size:12.5px}
    }
  </style>
</head>
<body class="theme-emerald">
  <div class="page">
    <div class="card">
      <div class="header">
        <div class="brand">
          <span class="logo" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="url(#grad)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <defs><linearGradient id="grad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" style="stop-color: var(--accent)"/><stop offset="100%" style="stop-color: var(--admin)"/></linearGradient></defs>
              <rect x="4" y="6" width="10" height="6" rx="2"></rect>
              <rect x="10" y="12" width="10" height="6" rx="2"></rect>
            </svg>
          </span>
          <div>
            <div class="title">BatchPay</div>
            <div class="merchant">Integreret i: Tony's Pizza · Demo</div>
          </div>
        </div>
        <div class="rightHead">
          <div class="user" id="userInfo">Logget ind</div>
          <span class="swatches">
            <span class="swLabel">Tema:</span>
            <span class="sw emerald" title="Emerald" data-theme="emerald"></span>
            <span class="sw sapphire" title="Sapphire" data-theme="sapphire"></span>
            <span class="sw violet" title="Violet" data-theme="violet"></span>
            <span class="sw sunset" title="Sunset" data-theme="sunset"></span>
          </span>
        </div>
      </div>

      <div class="topctl">
        <div class="row" style="gap:10px">
          <div id="boostToggle" class="toggle on" role="switch" aria-checked="true" title="Fremhæv administrator"></div>
          <div class="toggleLabel">Fremhæv administrator</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="people">Oversigt pr. person</button>
        <button class="tab" data-tab="items">Oversigt pr. vare</button>
      </div>

      <div class="content" id="content"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalOverlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="m-title">
      <div class="m-head">
        <div id="m-title" class="m-title">Titel</div>
        <button class="x" aria-label="Luk modal" onclick="closeModal()">✕</button>
      </div>
      <div id="m-body" class="m-body">Body</div>
      <div class="m-foot">
        <button class="btn" onclick="closeModal()">Luk</button>
      </div>
    </div>
  </div>

  <script>
    // Gendan tema + vis brugernavn
    const savedTheme = localStorage.getItem('batchpay_theme');
    if(savedTheme){ document.body.className = 'theme-'+savedTheme; }
    const username = localStorage.getItem('bp_username') || 'Demo-bruger';
    document.getElementById('userInfo').textContent = 'Logget ind som: ' + username;

    // Tema skifter
    document.querySelectorAll('.sw').forEach(sw=>{
      sw.addEventListener('click', ()=>{
        const t = sw.getAttribute('data-theme');
        document.body.className = 'theme-'+t;
        localStorage.setItem('batchpay_theme', t);
      });
    });

    // ------- Demo data -------
    const currentUserUid = 'jonas';
    const orders = [
      { id:'A12', title:"Tony's Pizza · Fredagshygge", adminUid:'maja',
        lines:[ {key:'marg',name:'Margherita',price:85},{key:'pep',name:'Pepperoni',price:200},{key:'cola',name:'Cola 0,5L',price:135} ],
        people:[
          {uid:'maja',initials:'MJ',name:'Maja',state:'paid',lines:{pep:{base:100,enabled:true},cola:{base:25,enabled:true}}},
          {uid:'jonas',initials:'JO',name: username + " (dig)",state:'pending',lines:{marg:{base:85,enabled:true},cola:{base:45,enabled:true}}},
          {uid:'liva',initials:'LI',name:'Liva',state:'paid',lines:{pep:{base:100,enabled:true},cola:{base:45,enabled:true}}},
          {uid:'noah',initials:'NO',name:'Noah',state:'pending',lines:{cola:{base:20,enabled:true}}}
        ]
      },
      { id:'D88', title:"Tony's Pizza · Team aften", adminUid:'noah',
        lines:[ {key:'marg',name:'Margherita',price:85},{key:'pep',name:'Pepperoni',price:100},{key:'cola',name:'Cola 0,5L',price:100} ],
        people:[
          {uid:'noah',initials:'NO',name:'Noah',state:'pending',lines:{pep:{base:100,enabled:true}}},
          {uid:'jonas',initials:'JO',name: username + " (dig)",state:'pending',lines:{marg:{base:85,enabled:true},cola:{base:50,enabled:true}}},
          {uid:'maja',initials:'MJ',name:'Maja',state:'paid',lines:{cola:{base:50,enabled:true}}}
        ]
      },
      { id:'E77', title:"Takeaway · Fodboldaften", adminUid:'jonas',
        lines:[ {key:'burger',name:'Burger menu',price:360},{key:'cola',name:'Cola 0,5L',price:60} ],
        people:[
          {uid:'jonas',initials:'JO',name: username + " (dig)",state:'pending',lines:{burger:{base:120,enabled:true},cola:{base:20,enabled:true}}},
          {uid:'mikkel',initials:'MI',name:'Mikkel',state:'pending',lines:{burger:{base:120,enabled:true},cola:{base:20,enabled:true}}},
          {uid:'sara',initials:'SA',name:'Sara',state:'paid',lines:{burger:{base:120,enabled:true},cola:{base:20,enabled:true}}}
        ],
        locked:false, deadlineSecs:20*60
      }
    ];

    // ------- UI state -------
    const uiState = { orderOpen:{}, personOpen:{} };
    function ensurePersonState(orderId){ if(!uiState.personOpen[orderId]) uiState.personOpen[orderId]={}; }

    // Helpers
    const personSum = (p) => Object.values(p.lines).reduce((a,x)=>a+(x.enabled?x.base:0),0);
    const orderTotal = (o) => o.lines.reduce((a,l)=>a+l.price,0);
    const paidCount = (o) => o.people.filter(p=>p.state==='paid').length;
    function statusOf(o){ if(o.cancelled) return 'Annulleret'; const pc=paidCount(o); if(pc===0) return 'Afventer'; if(pc===o.people.length) return 'Fuldført'; return 'I gang'; }
    const isAdmin = (o) => o.adminUid===currentUserUid;
    const adminDisplayName = (o) => { const person=o.people.find(p=>p.uid===o.adminUid); return person ? person.name.replace(' (dig)','') : '—'; }
    const findCurrentUserIndex = (o) => o.people.findIndex(p=>p.uid===currentUserUid);

    // Modaler
    const modalContent = {
      copyLink: { title:'Kopiér link', body:(o)=>`Kopiér deltagerlink til <b>${o.title}</b>.` },
      leaveOrder:{ title:'Forlad ordre', body:(o)=>`Forlad <b>${o.title}</b> (demo).` },
      payShare:{ title:'Betal din andel', body:(o)=>`Betal din andel. Fællesbetaling sker først når alle er klar.` },
      invite:{ title:'Invitér deltagere', body:(o)=>`Invitér via e-mail, link eller QR.` },
      lockCart:{ title:'Lås/åbn kurv', body:(o)=>`Lås kurven mens du afstemmer.` },
      remind:{ title:'Send påmindelse', body:(o)=>`Send påmindelser til dem, der mangler.` },
      deadline:{ title:'Sæt frist', body:(o)=>`Tilføj betalingsfrist for ordren.` },
      cancel:{ title:'Annullér ordre', body:(o)=>`Annullér hele ordren (demo).` }
    };
    function openModal(key, order){ const m=modalContent[key]; if(!m) return; document.getElementById('m-title').innerHTML=m.title; document.getElementById('m-body').innerHTML=typeof m.body==='function'?m.body(order):m.body; const ov=document.getElementById('modalOverlay'); ov.classList.add('open'); ov.setAttribute('aria-hidden','false'); }
    function closeModal(){ const ov=document.getElementById('modalOverlay'); ov.classList.remove('open'); ov.setAttribute('aria-hidden','true'); }
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
    document.getElementById('modalOverlay').addEventListener('click', (e)=>{ if(e.target.id==='modalOverlay') closeModal(); });

    // Toolbar HTML
    function renderToolbarHTML(o, oi){
      const admin=isAdmin(o); const myIdx=findCurrentUserIndex(o); const mySum=myIdx>=0?personSum(o.people[myIdx]):0;
      if(!admin){
        return `<div class="toolbar">
          <button class="btn openModal" data-action="copyLink" data-oi="${oi}">Kopiér link</button>
          <button class="btn openModal" data-action="leaveOrder" data-oi="${oi}">Forlad ordre</button>
          <button id="payBtn_${oi}" class="btn primary openModal" data-action="payShare" data-oi="${oi}">Betal din andel (DKK ${mySum})</button>
        </div>`;
      }
      return `<div class="toolbar admin">
        <button class="btn openModal" data-action="copyLink" data-oi="${oi}">Kopiér link</button>
        <button class="btn openModal" data-action="invite" data-oi="${oi}">Invitér deltagere</button>
        <button class="btn openModal" data-action="lockCart" data-oi="${oi}">${o.locked?'Åbn kurv':'Lås kurv'}</button>
        <button class="btn openModal" data-action="remind" data-oi="${oi}">Påmindelse</button>
        <button class="btn openModal" data-action="deadline" data-oi="${oi}">Sæt frist</button>
        <button class="btn ghost openModal" data-action="cancel" data-oi="${oi}">Annullér</button>
        <button id="payBtn_${oi}" class="btn primary openModal" data-action="payShare" data-oi="${oi}">Betal din andel (DKK ${mySum})</button>
      </div>`;
    }

    // --------- Render: People ---------
    function renderPeopleView(){
      const wrap=document.getElementById('content'); wrap.innerHTML='';
      orders.forEach((o,oi)=>{
        const card=document.createElement('div'); card.className='orderCard';
        const total=orderTotal(o), pc=paidCount(o), status=statusOf(o);
        const pillCls=status==='Fuldført'?'ok':(status==='I gang'?'warn':'bad');
        const headId='orderHead_'+oi, bodyId='orderBody_'+oi;
        const adminLabel=`<span class="muted">· Administrator: ${adminDisplayName(o)}</span>`;
        const adminBadge=isAdmin(o)?'<span class="adminBadge">🛡️ Admin</span>':'';

        card.innerHTML = `
          <div id="${headId}" class="orderHead" role="button" aria-expanded="false" aria-controls="${bodyId}">
            <div class="orderTitle"><span class="chev">▶</span><strong>${o.title}</strong>${adminBadge}${adminLabel}</div>
            <div class="orderMeta">
              <span class="pill">Total DKK ${total}</span>
              <span class="pill"><strong>${pc}/${o.people.length} betalt</strong></span>
              <span class="pill ${pillCls}">${status}</span>
            </div>
          </div>
          <div id="${bodyId}" class="orderBody" aria-hidden="true">
            ${renderToolbarHTML(o, oi)}
            <div class="acc" id="acc_${oi}"></div>
          </div>`;

        if(uiState.orderOpen[o.id]){ card.classList.add('open'); setTimeout(()=>{card.querySelector('#'+headId)?.setAttribute('aria-expanded','true'); card.querySelector('#'+bodyId)?.setAttribute('aria-hidden','false');},0); }
        card.querySelector('#'+headId).addEventListener('click',()=>toggleOrder(card,o.id));
        renderPeopleAccordion(oi, card, o);
        wrap.appendChild(card);
      });
      wireModals();
    }

    function renderPeopleAccordion(orderIndex, card, o){
      const acc=card.querySelector('#acc_'+orderIndex); acc.innerHTML=''; ensurePersonState(o.id);
      o.people.forEach((p,pi)=>{
        const item=document.createElement('div'); item.className='acc-item';
        const paid=p.state==='paid'; const sum=personSum(p);
        const headId='phead_'+orderIndex+'_'+pi, bodyId='pbody_'+orderIndex+'_'+pi;
        let bodyHtml='';
        Object.entries(p.lines).forEach(([key,meta])=>{
          const line=o.lines.find(x=>x.key===key);
          const on=meta.enabled; const canToggle = !o.locked && (p.uid===currentUserUid || isAdmin(o));
          bodyHtml += `
            <div class="line-row">
              <div class="line-name"><strong>${line.name}</strong><span class="muted">${canToggle?'Din andel':'Låst'}</span></div>
              <div class="row" style="gap:10px">
                <div class="line-amount">DKK ${meta.base}</div>
                <div class="switch ${on?'on':''}" role="switch" aria-checked="${on?'true':'false'}" ${canToggle?'':'aria-disabled="true"'} onclick="${canToggle?('toggleLine('+orderIndex+','+pi+',\''+key+'\', this)'):'void(0)'}"></div>
              </div>
            </div>`;
        });

        item.innerHTML = `
          <div id="${headId}" class="acc-head" role="button" aria-expanded="false" aria-controls="${bodyId}">
            <div class="acc-left">
              <div class="avatar">${p.initials}</div>
              <div>
                <div class="name">${p.name}</div>
                <div class="muted status">${paid?'✅ Betalt':'⏳ Afventer'}</div>
              </div>
            </div>
            <div class="row" style="gap:6px">
              <span class="muted">Sum</span>
              <strong class="sum" id="sum_${orderIndex}_${pi}">DKK ${sum}</strong>
              <span class="chev">▶</span>
            </div>
          </div>
          <div id="${bodyId}" class="acc-body" aria-hidden="true">${bodyHtml || '<div class="muted" style="margin-top:6px">Ingen tilknyttede linjer</div>'}</div>`;

        if(uiState.personOpen[o.id][p.uid]){ item.classList.add('open'); setTimeout(()=>{item.querySelector('#'+headId)?.setAttribute('aria-expanded','true'); item.querySelector('#'+bodyId)?.setAttribute('aria-hidden','false');},0); }
        item.querySelector('#'+headId).addEventListener('click',()=>togglePerson(item,o.id,p.uid));
        acc.appendChild(item);
      });
    }

    // --------- Render: Items ---------
    function renderItemsView(){
      const wrap=document.getElementById('content'); wrap.innerHTML='';
      orders.forEach((o,oi)=>{
        const card=document.createElement('div'); card.className='orderCard';
        const total=orderTotal(o), pc=paidCount(o), status=statusOf(o);
        const pillCls=status==='Fuldført'?'ok':(status==='I gang'?'warn':'bad');
        const headId='orderHeadItems_'+oi, bodyId='orderBodyItems_'+oi;
        const adminLabel=`<span class="muted">· Administrator: ${adminDisplayName(o)}</span>`;
        const adminBadge=isAdmin(o)?'<span class="adminBadge">🛡️ Admin</span>':'';

        card.innerHTML = `
          <div id="${headId}" class="orderHead" role="button" aria-expanded="false" aria-controls="${bodyId}">
            <div class="orderTitle"><span class="chev">▶</span><strong>${o.title}</strong>${adminBadge}${adminLabel}</div>
            <div class="orderMeta">
              <span class="pill">Total DKK ${total}</span>
              <span class="pill"><strong>${pc}/${o.people.length} betalt</strong></span>
              <span class="pill ${pillCls}">${status}</span>
            </div>
          </div>
          <div id="${bodyId}" class="orderBody" aria-hidden="true">
            ${renderToolbarHTML(o, oi)}
            <div class="itemList" id="itemList_${oi}"></div>
          </div>`;

        if(uiState.orderOpen[o.id]){ card.classList.add('open'); setTimeout(()=>{card.querySelector('#'+headId)?.setAttribute('aria-expanded','true'); card.querySelector('#'+bodyId)?.setAttribute('aria-hidden','false');},0); }
        card.querySelector('#'+headId).addEventListener('click',()=>toggleOrder(card,o.id));
        renderItemsList(oi, card, o);
        wrap.appendChild(card);
      });
      wireModals();
    }

    function renderItemsList(orderIndex, card, o){
      const list=card.querySelector('#itemList_'+orderIndex); list.innerHTML='';
      o.lines.forEach(line=>{
        const chips=[];
        o.people.forEach(p=>{ const item=p.lines[line.key]; if(item && item.enabled && item.base>0){ chips.push(`<span class="chip">${p.name.split(' ')[0]} · DKK ${item.base}</span>`); } });
        const div=document.createElement('div'); div.className='itemCard'; div.innerHTML=`
          <div class="row" style="margin-bottom:4px">
            <div><strong style="font-size:13px">${line.name}</strong><div class="muted">Linjetotal: DKK ${line.price}</div></div>
            <div class="muted">${chips.length} deltagere</div>
          </div>
          <div class="chips">${chips.join('') || '<span class="muted">Ingen bestillinger på denne linje</span>'}</div>`;
        list.appendChild(div);
      });
    }

    // --------- Interaction helpers ---------
    function toggleOrder(card, orderId){ const open=card.classList.toggle('open'); card.querySelector('.orderHead').setAttribute('aria-expanded',open?'true':'false'); card.querySelector('.orderBody').setAttribute('aria-hidden',open?'false':'true'); uiState.orderOpen[orderId]=open; }
    function togglePerson(item, orderId, uid){ const open=item.classList.toggle('open'); item.querySelector('.acc-head').setAttribute('aria-expanded',open?'true':'false'); item.querySelector('.acc-body').setAttribute('aria-hidden',open?'false':'true'); ensurePersonState(orderId); uiState.personOpen[orderId][uid]=open; }
    function toggleLine(orderIdx, personIdx, lineKey, el){
      const o=orders[orderIdx], p=o.people[personIdx]; if(o.locked) return;
      const meta=p.lines[lineKey]; meta.enabled=!meta.enabled;
      el.classList.toggle('on', meta.enabled); el.setAttribute('aria-checked', meta.enabled?'true':'false');
      const sumEl=document.getElementById('sum_'+orderIdx+'_'+personIdx); if(sumEl) sumEl.textContent='DKK '+personSum(p);
      const myIdx=findCurrentUserIndex(o); const btn=document.getElementById('payBtn_'+orderIdx); if(btn && myIdx>=0) btn.textContent='Betal din andel (DKK '+personSum(o.people[myIdx])+')';
      if(currentTab==='items') renderItemsView();
    }

    function wireModals(){ document.querySelectorAll('.openModal').forEach(btn=>btn.addEventListener('click',(e)=>{ e.stopPropagation(); const oi=parseInt(btn.getAttribute('data-oi'),10); const action=btn.getAttribute('data-action'); openModal(action, orders[oi]); })); }

    // Admin highlight toggle (kun kosmetisk i demo)
    const boost=document.getElementById('boostToggle'); function applyBoost(){ document.body.classList.toggle('adminBoost', boost.classList.contains('on')); } boost.addEventListener('click', ()=>{ boost.classList.toggle('on'); boost.setAttribute('aria-checked', boost.classList.contains('on')?'true':'false'); applyBoost(); });

    // Tabs
    let currentTab='people'; function setTab(t){ currentTab=t; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); document.querySelector('.tab[data-tab="'+t+'"]').classList.add('active'); if(t==='people') renderPeopleView(); else renderItemsView(); }
    document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click', ()=> setTab(b.dataset.tab)));

    // init
    const saved = localStorage.getItem('batchpay_theme'); if(saved){ document.body.className='theme-'+saved; }
    applyBoost(); setTab('people');
  </script>
</body>
</html>
